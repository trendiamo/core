{%- assign limit = section.settings.grid | times: section.settings.rows -%}
{%- paginate collection.products by limit -%}
{%- assign collection_about_image_url = collection.metafields.custom_fields["about_image_url"] -%}
{%- assign collection_about_video_id = collection.metafields.custom_fields["about_video_url"] -%}
{%- assign header_media_present = false -%}

{%- if template == 'collection.seller' -%}
  {%- assign is_seller = true -%}
{%- else -%}
  {%- assign is_seller = false -%}
{%- endif -%}

{%- if is_seller -%}
  {%- assign center_title = true %}
  {%- if collection_about_video_id != null or collection_about_image_url != null -%}
    {%- assign header_media_present = true -%}
  {%- else -%}
    {%- assign header_media_present = false -%}
  {%- endif -%}
{%- else -%}
  {%- assign center_title = false %}
  {%- if collection.image -%}
    {%- assign header_media_present = true -%}
  {%- else -%}
    {%- assign header_media_present = false -%}
  {%- endif -%}
{%- endif -%}

<!-- {% assign filterable_tags = collection.all_tags %} -->
{%- capture filterable_tags_string -%}
  {%- for tag in collection.all_tags -%}
    {%- if tag contains ':' -%}{%- continue -%}{%- endif -%}
    {{ tag }}
    {%- if forloop.last == false -%}::{%- endif -%}
  {%- endfor -%}
{%- endcapture -%}
{%- assign filterable_tags = filterable_tags_string | split: '::' -%}

<section class="section" data-section-id="{{ section.id }}" data-section-type="collection-template">

    <div class="collection{% if header_media_present and section.settings.show_collection_image %} collection--img{% endif %}{% if center_title %} collection--center{% endif %}">

        <div class="collection__header{% if header_media_present and section.settings.show_collection_image %} collection__header--img{% endif %}">
            <div class="container">
                {% if header_media_present and section.settings.show_collection_image %}
                    <div class="collection__header-media">
                      {%- if is_seller -%}
                        {%- if collection_about_video_id != null -%}
                          <iframe id="pdp-video" style="height:100%;" src="https://www.youtube.com/embed/{{ collection_about_video_id }}?rel=0&enablejsapi=1" frameborder="0" allowfullscreen tabindex="-1"></iframe>
                          <div class="video-placeholder u-flex u-flex--middle u-flex--center u-bg-cover u-bg-overlay u-bg-overlay--medium js-home-video-placeholder" style="background-image: url(https://img.youtube.com/vi/{{ collection_about_video_id }}/sddefault.jpg);">
                            <a class="video-placeholder-btn c-btn c-btn--primary c-btn--play icon-fallback js-video-placeholder-trigger">
                              <i class="icon icon--play" aria-hidden="true"></i>
                              <span class="icon-fallback__text">Play</span>
                            </a>
                          </div>
                        {%- else -%}
                          {%- if collection_about_image_url != null -%}
                            <img alt="" class="collection__header-image" src="{{ collection_about_image_url }}" />
                          {%- endif -%}
                        {%- endif -%}
                      {%- else -%}
                        <div class="collection__header-img collection__header-img--{{ section.id }} u-bg-cover u-bg-grey lazyload js"
                            data-bgset="{% include 'bgset', image: collection.image %}"
                            data-sizes="auto"
                            data-parent-fit="cover"
                            style="background-image: url('{{ collection.image | img_url: '300x300' }});"></div>
                        <noscript>
                            <div class="collection__header-img collection__header-img--{{ section.id }} u-bg-cover u-bg-grey"
                                style="background-image: url('{{ collection.image | img_url: '1400x' }});">
                            </div>
                        </noscript>
                      {%- endif -%}
                    </div>
                {% endif %}
                <div class="collection__header-info"{% if is_seller %} style="padding-top: 40px;"{% else %} style="background: #fff;"{% endif %}>
                    {%- if is_seller -%}
                      <div class="collection-seller-info">
                        <div class="seller-info-profilepic-container">
                          <img alt="" class="seller-info-profilepic" src="{{ collection.image | img_url: 'compact' }}" />
                        </div>
                        <div class="seller-info-description-container">
                          <h1 class="collection-seller-info-title">{{ collection.title }}</h1>
                          {%- assign description_parts = collection.description | split: '<p>###</p>' -%}
                          {%- if description_parts.size > 1 -%}
                            <div>{{ description_parts | first }}</div>
                            <div class="js-description-full u-hiddenVisually">{{ description_parts | last }}</div>
                            <button type="button" class="action-link link--arrow-down js-show-more">Show more</button>
                            <button type="button" class="action-link link--arrow-up js-show-less u-hiddenVisually">Show less</button>
                          {%- else -%}
                            <div>{{ collection.description }}</div>
                          {%- endif -%}
                        </div>
                      </div>
                    {%- else -%}
                      <div class="section__title collection__header-info__title{% if center_title %} section__title--center{% endif %}">
                          <h1 class="section__title-text collection__header-info__title-text">
                            {{ collection.title }}
                          </h1>
                      </div>
                      {% if collection.description != blank %}
                          <div class="collection__header-info__text rte rte--header">
                              {{ collection.description }}
                          </div>
                      {% endif %}
                    {%- endif -%}
                </div>
            </div>
        </div>

        <div class="container">
            {% case section.settings.grid %}
                {% when 2 %}
                    {%- assign grid_item_width = 'u-1/1 u-1/2@phab' -%}
                    {%- assign sort_width = 'u-1/1 u-1/2@tab' -%}
                    {%- assign image_size = '740x' -%}
                {% when 3 %}
                    {%- assign grid_item_width = 'u-1/1 u-1/2@phab u-1/3@tab' -%}
                    {%- assign sort_width = 'u-1/1 u-1/2@tab u-1/3@desk' -%}
                    {%- assign image_size = '520x' -%}
                {% when 4 %}
                    {%- assign grid_item_width = 'u-1/2 u-1/3@tab u-1/4@desk' -%}
                    {%- assign sort_width = 'u-1/1 u-1/2@tab' -%}
                    {%- assign image_size = '380x' -%}
            {% endcase %}

            <div class="collection-main" id="collection-main">

                <div class="collection-main__sort js-collection-sort" data-default-sort="{{ collection.sort_by | default: collection.default_sort_by }}">
                    {% comment %}Sidebar blocks count{% endcomment %}
                    {% if section.settings.show_sidebar and section.blocks.size > 0 %}
                    <div class="o-layout o-layout--right">
                        <div class="o-layout__item u-1/1 u-3/4@desk">
                    {% endif %}
                    {% comment %}Sidebar blocks count{% endcomment %}
                            <div class="o-layout{% if section.settings.sort_enable %} o-layout--right{% endif %}{% if section.settings.grid == 4 %} o-layout--small{% endif %}">

                                {% comment %}Sidebar blocks count{% endcomment %}
                                {% if section.settings.show_sidebar and section.blocks.size > 0 %}
                                    <div class="o-layout__item u-1/1 u-1/2@tab">
                                        <div class="collection-main__filter">
                                            <a href="#" class="collection-main__filter-btn c-btn c-btn--primary c-btn--full js-collection-draw-trigger">{{ 'collections.general.filter_label' | t }}{% if current_tags %} ({{ current_tags | size }}){% endif %}</a>
                                        </div>
                                    </div>
                                {% endif %}
                                {% comment %}Sidebar blocks count{% endcomment %}

                                {% if section.settings.sort_enable %}
                                    <div class="o-layout__item {{ sort_width }}">

                                        <div id="bc-sf-filter-top-sorting" class="selector-wrapper">
                                            <label for="SortBy">{{ 'collections.sorting.title' | t }}</label>
                                            <select name="SortBy" id="SortBy">
                                                <option value="manual">{{ 'collections.sorting.featured' | t }}</option>
                                                <option value="best-selling">{{ 'collections.sorting.best_selling' | t }}</option>
                                                <option value="title-ascending">{{ 'collections.sorting.az' | t }}</option>
                                                <option value="title-descending">{{ 'collections.sorting.za' | t }}</option>
                                                <option value="price-ascending">{{ 'collections.sorting.price_ascending' | t }}</option>
                                                <option value="price-descending">{{ 'collections.sorting.price_descending' | t }}</option>
                                                <option value="created-descending">{{ 'collections.sorting.date_descending' | t }}</option>
                                                <option value="created-ascending">{{ 'collections.sorting.date_ascending' | t }}</option>
                                            </select>
                                        </div>

                                    </div>
                                {% endif %}
                            </div>
                    {% comment %}Sidebar blocks count{% endcomment %}
                    {% if section.settings.show_sidebar and section.blocks.size > 0 %}
                        </div>
                    </div>
                    {% endif %}
                    {% comment %}Sidebar blocks count{% endcomment %}
                </div>

                <div class="collection-products">

                    {% comment %}Sidebar blocks count{% endcomment %}
                    {% if section.settings.show_sidebar and section.blocks.size > 0 %}
                    <div class="o-layout">

                        <div class="o-layout__item u-1/1 u-1/4@desk">
                            <aside class="collection-sidebar collection-sidebar--{{ settings.color_drawer_style }} u-bg-{{ settings.color_drawer_bg }} js-collection-draw">

                              <div id="bc-sf-filter-tree"></div>
                            </aside>
                        </div>

                        <div class="o-layout__item u-1/1 u-3/4@desk">

                    {% endif %}
                    {% comment %}Sidebar blocks count{% endcomment %}

                            <div id="bc-sf-filter-products" class="o-layout{% if settings.product_grid_masonry %} o-layout--masonry{% endif %}{% if section.settings.grid == 4 %} o-layout--small{% endif %}">
                                {% for product in collection.products %}
                                    <div class="o-layout__item {{ grid_item_width }}">
                                        {% include 'product-grid-item', grid_image_width: image_size, page: 'collection' %}
                                    </div>
                                {% else %}
                                    {% if collection.handle == 'all' and collection.all_vendors.size == 0 and collection.all_types.size == 0 %}
                                        {% comment %}
                                            Add default products to help with onboarding for collections/all only.
                                        {% endcomment %}
                                        {% for i in (1..8) %}
                                            <div class="o-layout__item {{ grid_item_width }}">
                                                <a href="#" class="product-link home-products__link">
                                                    <div class="product product--{{ settings.product_grid_align }}">
                                                        <div class="product__media u-bg-{{ settings.product_grid_bg }}">
                                                            {% capture current %}{% cycle 1, 2, 3, 4, 5, 6 %}{% endcapture %}
                                                            {{ 'product-' | append: current | placeholder_svg_tag: 'product__img placeholder-svg' }}
                                                        </div>
                                                        <div class="product__details product__details--{{ settings.product_grid_text_size }}">
                                                            <h3 class="product__title">{{ 'homepage.onboarding.product_title' | t }}</h3>
                                                            {% if settings.product_grid_vendor %}
                                                                <p class="product__vendor">{{ 'homepage.onboarding.product_vendor' | t }}</p>
                                                            {% endif %}
                                                            <p class="product__price">
                                                                {% include 'product-price' %}
                                                            </p>
                                                        </div>
                                                    </div>
                                                </a>
                                            </div>
                                        {% endfor %}
                                    {% else %}
                                        <div class="o-layout__item 1/1">
                                            <div class="collection-empty">
                                                <h5 class="collection-empty__title">{{ 'collections.general.no_matches' | t }}</h5>
                                                <span class="emoji collection-empty__emoji">
                                                    <i class="icon icon--confused"></i>
                                                </span>
                                            </div>
                                        </div>
                                    {% endif %}
                                {% endfor %}
                            </div>

                    {% comment %}Sidebar blocks count{% endcomment %}
                    {% if section.settings.show_sidebar and section.blocks.size > 0 %}
                        </div>
                    </div>
                    {% endif %}
                    {% comment %}Sidebar blocks count{% endcomment %}
                </div>

            </div>

            {% if paginate.pages > 1 %}
              <div class="collection-pagination">
                  <div class="container">
                      <div class="pagination">
                          <div id="bc-sf-filter-bottom-pagination" class="pagination__items"></div>
                          <div id="bc-sf-filter-load-more"></div>
                      </div>
                  </div>
              </div>
            {% endif %}

        </div>

    </div>
</section>

{% endpaginate %}

<script>
  // Declare bcSfFilterConfig variable
  var bcSfFilterConfig = {
    label: {
      sorting: {% assign temp = 'collections.sorting.title' | t  %} {% unless temp contains 'translation missing'  %} {{temp | json}} {% else %} "Sorting" {% endunless %},
      sorting_best_selling: {% assign temp = 'collections.sorting.best_selling' | t %} {% unless temp contains 'translation missing'  %} {{temp | json}} {% else %} "Best Selling" {% endunless %},
      sorting_featured: {% assign temp = 'collections.sorting.featured' | t %} {% unless temp contains 'translation missing'  %} {{temp | json}} {% else %} "Featured" {% endunless %},
      sorting_title_ascending: {% assign temp = 'collections.sorting.az' | t %} {% unless temp contains 'translation missing'  %} {{temp | json}} {% else %} "Alphabetically, A-Z" {% endunless %},
      sorting_title_descending: {% assign temp = 'collections.sorting.za' | t %} {% unless temp contains 'translation missing'  %} {{temp | json}} {% else %} "Alphabetically, Z-A" {% endunless %},
      sorting_price_ascending: {% assign temp = 'collections.sorting.price_ascending' | t %} {% unless temp contains 'translation missing'  %} {{temp | json}} {% else %} "Lowest Price" {% endunless %},
      sorting_price_descending: {% assign temp = 'collections.sorting.price_descending' | t %} {% unless temp contains 'translation missing'  %} {{temp | json}} {% else %} "Highest Price" {% endunless %},
      sorting_date_ascending: {% assign temp = 'collections.sorting.date_ascending' | t %} {% unless temp contains 'translation missing'  %} {{temp | json}} {% else %} "Date, Old to New" {% endunless %},
      sorting_date_descending: {% assign temp = 'collections.sorting.date_descending' | t %} {% unless temp contains 'translation missing'  %} {{temp | json}} {% else %} "Date, New to Old" {% endunless %},
      sorting_sale_descending: {% assign temp = 'collections.sorting.sale_descending' | t %} {% unless temp contains 'translation missing'  %} {{temp | json}} {% else %} "% Off" {% endunless %},
      sorting_relevance: {% assign temp = 'collections.sorting.relevance' | t %} {% unless temp contains 'translation missing'  %} {{temp | json}} {% else %} "Relevance" {% endunless %},

      filter_label: {{ 'collections.general.filter_label' | t | json }},
      tags_clear: {{ 'collections.general.tags_clear' | t | json }},
      on_sale: {{ 'products.product.on_sale' | t | json }},
      sold_out: {{ 'products.product.sold_out' | t | json }},
    },
    custom: {
      products_per_page: {% if limit %} {{ limit | json }} {% else %} 20 {% endif %},
      grid: {% if section.settings.grid %} {{ section.settings.grid }} {% else %} 4 {% endif %},
      rows: {% if section.settings.rows %} {{ section.settings.rows }} {% else %} 5 {% endif %},
      grid_item_width: {% if grid_item_width %} {{ grid_item_width | json }} {% else %} "u-1\/2 u-1\/3@tab u-1\/4@desk" {% endif %},
      image_size: {% if image_size %} {{ image_size | json }} {% else %} "380x" {% endif %},
      sort_width: {% if sort_width %} {{ sort_width | json }} {% else %} "u-1\/1 u-1\/2@tab" {% endif %},
      show_sidebar: {% if section.settings.show_sidebar %} {{ section.settings.show_sidebar | json }} {% else %} false {% endif %},
      product_grid_masonry: {% if settings.product_grid_masonry %} {{ settings.product_grid_masonry | json }} {% else %} false {% endif %},
      product_grid_align: {% if settings.product_grid_align %} {{ settings.product_grid_align | json }} {% else %} "center" {% endif %},
      product_grid_text_size: {% if settings.product_grid_text_size %} {{ settings.product_grid_text_size | json }} {% else %} "" {% endif %},
      product_grid_bg: {% if settings.product_grid_bg %} {{ settings.product_grid_bg | json }} {% else %} "white" {% endif %},
      show_collection_image: {% if section.settings.show_collection_image %} {{ section.settings.show_collection_image | json }} {% else %} false {% endif %},
      product_grid_label: {% if settings.product_grid_label %} {{ settings.product_grid_label | json }} {% else %} false {% endif %},
      product_grid_vendor: {% if settings.product_grid_vendor %} {{ settings.product_grid_vendor | json }} {% else %} false {% endif %},
      product_grid_second_hover: {% if settings.product_grid_second_hover %} {{ settings.product_grid_second_hover | json }} {% else %} false {% endif %},
      color_table: {{ settings.color_table | json }},
    }
  };
</script>

<script>
  $(function() {
    $('.js-show-more').click(function() {
      $('.js-show-more').hide();
      $('.js-show-less').show();
      $('.js-description-full').slideDown();
    });
    $('.js-show-less').click(function() {
      $('.js-show-less').hide();
      $('.js-show-more').show();
      $('.js-description-full').slideUp();
    });

    $('.js-video-placeholder-trigger').click(function() {
      $(this).parent('.js-home-video-placeholder').addClass('js-hidden');
      window.pdpVideoPlayer.playVideo();
      return false;
    });
  });
</script>

{% schema %}
{
    "name": "Collection page",
    "class": "js-section__collection",
    "max_blocks": 6,
    "settings": [
        {
            "type": "range",
            "id": "grid",
            "label": "Products per row",
            "min": 2,
            "max": 4,
            "step": 1,
            "default": 3
        },
        {
            "type": "range",
            "id": "rows",
            "label": "Rows",
            "min": 3,
            "max": 12,
            "step": 1,
            "default": 6
        },
        {
            "type": "checkbox",
            "id": "show_collection_image",
            "label": "Show collection image",
            "default": true
        },
        {
            "type": "checkbox",
            "id": "sort_enable",
            "label": "Enable sorting",
            "default": true
        },
        {
            "type": "header",
            "content": "Sidebar filter"
        },
        {
            "type": "checkbox",
            "id": "show_sidebar",
            "label": "Enable sidebar",
            "default": false
        },
        {
            "type": "paragraph",
            "content": "Use content below to add sidebar filters."
        }
    ],
    "blocks": [
        {
            "type": "linklist",
            "name": "Menu",
            "settings": [
                {
                    "type": "link_list",
                    "id": "linklist",
                    "label": "Menu",
                    "info": "This menu won't show dropdown items"
                }
            ]
        },
        {
            "type": "tags",
            "name": "Tags filter",
            "limit": 1,
            "settings": [
                {
                    "type": "text",
                    "id": "title",
                    "label": "Heading",
                    "default": "Filter"
                }
            ]
        }
    ]
}
{% endschema %}
