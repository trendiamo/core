#!/bin/sh

set -e

SSH=${1:-ssh}

[ -f .env ] && cp .env .env~

cat >.env <<EOL
NODE_ENV=production
REACT_APP_NODE_ENV=production
REACT_APP_API_ENDPOINT=https://api.frekkls.com
REACT_APP_POST_CLIENT_ITEM_ACCESS_TOKEN=e3db531697704c2cb51ac37fc5f3321b
EOL

cd ../plugin-base && yarn install-p && yarn build && cd ../console-frontend

yarn build

rm .env

[ -f .env~ ] && mv .env~ .env

cat >build/.htaccess <<EOL
RewriteEngine On
RewriteBase /
RewriteCond %{REQUEST_FILENAME} !-f
RewriteCond %{REQUEST_FILENAME} !-d
RewriteCond %{REQUEST_FILENAME} !-l
RewriteRule ^.*$ / [L,QSA]
EOL

rsync -azh -e $SSH --delete-after --ignore-errors build/ root@139.59.128.112:/var/www/admin.frekkls.com/html

rm -rf build/
cd ../plugin-base && yarn build-dev && cd ../console-frontend
