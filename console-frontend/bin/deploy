#!/bin/sh

set -e

SSH=${1:-ssh}

[ -f .env ] && cp .env .env~

cat >.env <<EOL
NODE_ENV=production
ROLLBAR_DEPLOY_TOKEN=dd53cbf082fd4960ac7baf7bf69da4d5
REACT_APP_NODE_ENV=production
REACT_APP_API_ENDPOINT=https://api.frekkls.com
REACT_APP_POST_CLIENT_ITEM_ACCESS_TOKEN=e3db531697704c2cb51ac37fc5f3321b
EOL

cd ../plugin-base && yarn install-p && yarn build && cd ../console-frontend

yarn build

cat >build/.htaccess <<EOL
RewriteEngine On
RewriteBase /
RewriteCond %{REQUEST_FILENAME} !-f
RewriteCond %{REQUEST_FILENAME} !-d
RewriteCond %{REQUEST_FILENAME} !-l
RewriteRule ^.*$ / [L,QSA]
EOL

rsync -azh -e $SSH --delete-after --ignore-errors build/ root@139.59.128.112:/var/www/admin.frekkls.com/html

rm -rf build/
cd ../plugin-base && yarn build-dev && cd ../console-frontend

# begin notify rollbar
ROLLBAR_DEPLOY_TOKEN=$(grep ROLLBAR_DEPLOY_TOKEN .env | xargs)
IFS='=' read -ra ROLLBAR_DEPLOY_TOKEN <<< "$ROLLBAR_DEPLOY_TOKEN"
ROLLBAR_DEPLOY_TOKEN=${ROLLBAR_DEPLOY_TOKEN[1]}
LOCAL_USERNAME=`whoami`
REVISION=`git rev-parse -q --verify HEAD`
curl https://api.rollbar.com/api/1/deploy/ \
  -F access_token=$ROLLBAR_DEPLOY_TOKEN \
  -F environment=production \
  -F revision=$REVISION \
  -F local_username=$LOCAL_USERNAME
# end notify rollbar

rm .env

[ -f .env~ ] && mv .env~ .env
